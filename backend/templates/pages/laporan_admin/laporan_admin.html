{% extends "layouts/main2.html" %}

{% block title %}Laporan Bulanan{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Data Laporan User</h4>
                    <div style="float: right"></div>
                    <div class="pt-3 table-responsive">
                        <table class="table table-bordered" id="data-table">
                            <thead>
                                <tr class="text-center">
                                    <th class="text-center" width="50">#</th>
                                    <th>Nama User</th>
                                    <th>Jenis Investasi</th>
                                    <th>Laporan Bulanan</th>
                                    <th>Lainnya</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in data_list %}
                                <tr class="text-center">
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ data.first_name }} {{ data.last_name }}</td>
                                    <td>{{ data.jenis_investasi }}</td>
                                    <td>
                                        {% if data.laporan_bulanan == "Sudah Dicek" %}
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                        {% else %}
                                            <i class="bi bi-x-circle-fill text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm btn-modal" data-id="{{ data.id }}"
                                            data-nama="{{ data.first_name }} {{ data.last_name }}" 
                                            data-jenis="{{ data.jenis_investasi }}"
                                            data-laporan="{{ data.laporan_bulanan }}">
                                            Selengkapnya
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="mdl" id="laporanModal" style="display: none;">
    <div class="mdl-dialog">
        <div class="mdl-content">
            <div class="mdl-header">
                <h5 class="mdl-title">Detail Laporan Bulanan</h5>
                <button type="button" class="close" id="closeModal">&times;</button>
            </div>
            <div class="mdl-body">
                <form id="uploadForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" value="{{ data.user.id }}">
                    <div class="form-group">
                        <label for="reportFile">Upload Laporan Bulanan (PDF):</label>
                        <input type="file" id="reportFile" name="report_file" accept="application/pdf"
                            class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="imbalHasil">Imba Hasil:</label>
                        <input type="number" id="imbalHasil" name="imbal_hasil" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="mdl-footer">
                <button type="submit" form="uploadForm" class="btn btn-primary">Simpan</button>
                <button type="button" class="btn btn-secondary" id="closeFooter">Tutup</button>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#data-table').DataTable({
            initComplete: function () {
                this.api().columns(3).every(function () {
                    var column = this;
                    var select = $('<select><option value="">Filter</option></select>')
                        .appendTo($(column.header()))
                        .on('change', function () {
                            var val = $.fn.dataTable.util.escapeRegex($(this).val());
                            column.search(val ? '^' + val + '$' : '', true, false).draw();
                        });

                    column.data().unique().sort().each(function (d, j) {
                        select.append('<option value="' + d + '">' + d + '</option>');
                    });
                });
            }
        });


        // Show Modal
        $('.btn-modal').click(function () {
            var nama = $(this).data('nama');
            var jenis = $(this).data('jenis');
            var laporan = $(this).data('laporan');

            // Isi data ke modal
            $('#modal-nama').text(nama);
            $('#modal-jenis').text(jenis);
            $('#modal-laporan').text(laporan);

            // Set nilai ke form hidden input
            $('input[name="user_id"]').val($(this).data('id'));

            $('#laporanModal').fadeIn();
        });

        // Close Modal
        $('#closeModal, #closeFooter').click(function () {
            $('#laporanModal').fadeOut();
        });

        // Validate File
        $('#reportFile').change(function () {
            const file = this.files[0];
            if (file && file.type !== 'application/pdf') {
                Swal.fire('Error', 'Hanya file PDF yang diperbolehkan!', 'error');
                $(this).val('');
            }
        });
    });
    $('form#uploadForm').on('submit', function (e) {
        e.preventDefault();
        // Lakukan submit via AJAX (contoh sederhana):
        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            data: new FormData(this),
            contentType: false,
            processData: false,
            success: function (response) {
                Swal.fire('Sukses', 'Laporan berhasil diunggah!', 'success');
                $('#laporanModal').fadeOut();
                location.reload(); // Reload halaman untuk memperbarui tabel
            },
            error: function () {
                Swal.fire('Error', 'Terjadi kesalahan saat mengunggah laporan.', 'error');
            }
        });
    });
</script>
{% endblock %}